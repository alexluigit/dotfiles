#!/bin/sh
FLOATWIN_STATE="$XDG_CACHE_HOME/floatwin"
TERMINAL=false
DIMENSION=1920x1080+0+0
TIMEOUT=100

__get_wid() {
  xdotool search --onlyvisible --desktop $(xdotool get_desktop) --classname $INSTANCE
}
__win_info() { bspc query -T -n $1 | jq "$2" | tr -d '"'; }
__win_visible() { ! $(__win_info $WID .hidden); }
__wid_expired() {
  wid_class=$(__win_info $WID .client.className)
  wid_instance=$(__win_info $WID .client.instanceName)
  [[ "$wid_instance" != "$INSTANCE" ]] && [[ "$wid_class" != "$CLASS" ]]
}
__hide_window() { bspc node $WID --flag hidden=on; }
__show_window() {
  xdotool set_desktop_for_window "$WID" "$(xdotool get_desktop)"
  bspc node $WID --flag hidden=off
  xdotool windowactivate $WID
}
__create_window() {
  killall $APP 2>/dev/null
  bspc rule -a $CLASS:$INSTANCE -o state=floating rectangle=$DIMENSION sticky=on
  t_cmd=(alacritty --class $CLASS,$INSTANCE)
  [[ "$APP" == "dropterm" ]] || t_cmd+=("-e $APP")
  $TERMINAL && eval "${t_cmd[@]} &" || eval "${CMD[@]} &"
  local time_out=0
  while (($time_out <= $TIMEOUT)); do
    wid=$(__get_wid)
    [[ -n "$wid" ]] && echo "$wid" > $FLOATWIN_STATE/$APP && break
    sleep .3; time_out=$((time_out + 1))
  done
  bspc rule -r $CLASS:$INSTANCE
}

_toggle_or_create() {
  if __wid_expired; then __create_window
  elif __win_visible; then __hide_window
  else __show_window
  fi
}

main() {
  [[ -d "$FLOATWIN_STATE" ]] || mkdir -p $FLOATWIN_STATE
  while getopts "a:b:c:d:i:t" opt; do
    case $opt in
      a) AFTER=$OPTARG;;
      b) BEFORE=$OPTARG;;
      c) CLASS=$OPTARG;;
      d) DIMENSION=$OPTARG;;
      i) INSTANCE=$OPTARG;;
      t) TERMINAL=true;;
    esac
  done
  shift $((OPTIND -1))
  CMD="$@"
  APP=${1:-dropterm}
  CLASS=${CLASS:-$APP}
  INSTANCE=${INSTANCE:-$CLASS}
  WID=$(cat "$FLOATWIN_STATE/$APP" 2>/dev/null)
  [ -n "$BEFORE" ] && ! pgrep "$BEFORE" >/dev/null && eval "$BEFORE &"
  _toggle_or_create
  [ -n "$AFTER" ] && ! pgrep "$AFTER" >/dev/null && eval "$AFTER &"
}

main "$@"
