#!/bin/sh
proxy="export http_proxy=http://127.0.0.1:1088; export https_proxy=http://127.0.0.1:1088"
video_url=("www.youtube.com")
stream_url=("live.bilibili.com" "www.huya.com" "www.douyu.com")
cache="$XDG_DATA_HOME/mpv_url"
time_out=5

__video_float() {
  host=$1
  echo $(xclip -o) >> $cache
  url=$(tail -1 $cache)
  exec tdrop -a -m -n MPV -h 30% -w 30% -x 2680 -y 60 -c "$proxy" mpv $url
}

__stream_float() {
  host=$1
  echo $(xclip -o) >> $cache
  url=$(tail -1 $cache)
  qlphelper -u $url &
  counter=0
  until [ $counter -ge $time_out ]; do
    wid=$(__check_visible)
    [[ -z $wid ]] && { sleep 1; counter=`expr $counter + 1`; } \
    || { __put_aside $wid; counter=$time_out; }
  done
}

__put_aside() {
  bspc node focused -t floating
  xdotool windowmap "$1" windowsize "$1" 30% 30% windowmove "$1" 2680 60
}
__check_mpv() { xdotool search --class mpv; }
__check_visible() { xdotool search --onlyvisible --desktop $(xdotool get_desktop) --class mpv; }
__state() { bspc query -n $1 -T | jq -r .client.state; }


main() {
  mpv_visible=$(__check_visible)
  host=$(xclip -o | awk -F[/:] '{print $4}')
  wid=$(__check_mpv)
  if [[ -n $mpv_visible ]]; then
    [[ $(__state $mpv_visible) == "floating" ]] && bspc node $mpv_visible --flag hidden=on
  elif pgrep qlphelper >/dev/null || [[ -n $wid ]]; then
    bspc node $wid --flag hidden=off
  elif [[ "${stream_url[@]}" == *"$host"* ]]; then
    __stream_float $host; return
  elif [[ "${video_url[@]}" == *"$host"* ]]; then
    __video_float $host; return
  else
    alacritty -e sh -c "sleep .1 && nvim $cache"
  fi
}

main $@
