#!/usr/bin/env zsh
START_FLAGS=(--proxy-server="127.0.0.1:1088")
DARKMODE=(--enable-features=WebContentsForceDark)
INCO=(--incognito)
DEV=(--user-data-dir=$XDG_CONFIG_HOME/brave-dev --class=BraveDev)
MUSIC=(--app-id=cinhimbnkkaeohfgghhklpknlkffjgod)
[[ $@ != *"--no-darkmode"* ]] && [[ $1 != "start-dev" ]] && START_FLAGS+=$DARKMODE

start() { _start }
start-inco() { START_FLAGS+=$INCO && _start }
start-dev() { START_FLAGS+=$DEV && _start }
music() { _try_switch music || _openmusic }
refresh() { _try_switch BraveDev && _refresh_tab }
fullscreen_yt() { __send_key "f" && alacritty -e "echo" }

_start() { __rmpki &; brave $(echo ${START_FLAGS[@]}) }
_openmusic() { START_FLAGS+=$MUSIC; _start && __fullscreen }
_refresh_tab() { sleep 0.1; __send_key '\Cr'; bspc node focused -f last }
_try_switch() { wid=$(__running_check $1); [[ -n $wid ]] && xdotool windowactivate $wid || return 1 }

__running_check() {
  [[ $1 == 'music' ]] && echo $(xdotool search --name 'Youtube Music') \
  || echo $(xdotool search --onlyvisible --desktop $(xdotool get_desktop) --class ${1:-brave})
}
__fullscreen() { __send_key "\[F11]" && alacritty -e "echo" }
__rmpki() { sleep 5 && rm -rf ~/.pki }
__send_key() { xvkbd -xsendevent -text $1 }

"$@"
