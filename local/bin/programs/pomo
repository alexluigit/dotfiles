#!/bin/zsh
WORK=25
REST=5
MUTE=false
ROUND_DEFAULT=10

__is_exist() {
  [[ -z $(ps aux | grep "[p]omo run" | awk '{print $2}') ]] && return 1
  return 0
}

__is_running() {
  [[ $(ps aux | grep "[p]omo run" | awk '{print $8}') =~ "T" ]] && return 1
  return 0
}

__play_notification() {
  mpv --really-quiet /home/alex/.local/share/assets/audio/notification.wav
}

run() {
  local ROUND=${1-$ROUND_DEFAULT}
  for ((j=$ROUND; j>0; j--)); do
    for ((i=$WORK; i>0; i--)); do
      echo -n " : "$i"m" > /tmp/pomo
      sleep 1m
    done
    ! $MUTE && __play_notification
    for ((i=$REST; i>0; i--)); do
      echo -n " : "$i"m" > /tmp/pomo
      sleep 1m
    done
    ! $MUTE && __play_notification
  done
}

toggle() {
  __is_exist && \
  kill -9 $(ps aux | grep "[p]omo run" | awk '{print $2}') \
  || exec pomo run $1 &
}

p() { # pause / "play"
  PID=$(ps aux | grep "[p]omo run" | awk '{print $2}')
  __is_running && { kill -STOP $PID && echo "  " >> /tmp/pomo } \
  || { kill -CONT $PID && sed -i s/\ \ // /tmp/pomo}
}

state() { __is_exist && cat /tmp/pomo }

"$@"
