#!/bin/sh
FLOATWIN_STATE="$XDG_CACHE_HOME/floatwin"
TERMINAL=false
DIMENSION=1920x1080+0+0
TIMEOUT=100

__get_wid() { xdotool search --onlyvisible --desktop $(xdotool get_desktop) --class $1; }
__win_visible() { [[ -n "$(__get_wid $CLASS)" ]]; }
__win_info() { bspc query -T -n $WID | jq "$@" | tr -d '"'; }
__wid_expired() {
  wid_class=$(__win_info .client.className)
  [[ "$wid_class" != "$CLASS" ]]
}
__hide_window() { bspc node $WID --flag hidden=on; }
__show_window() {
  xdotool set_desktop_for_window "$WID" "$(xdotool get_desktop)"
  bspc node $WID --flag hidden=off
  xdotool windowactivate $WID
}
__create_window() {
  bspc rule -a $CLASS -o state=floating rectangle=$DIMENSION sticky=on
  t_cmd=(alacritty --class $CLASS,$CLASS)
  [[ "$APP" == "dropterm" ]] || t_cmd+=("-e $APP")
  $TERMINAL && eval "${t_cmd[@]} &" || eval "${CMD[@]} &"
  local time_out=0
  while (($time_out <= $TIMEOUT)); do
    wid=$(__get_wid $CLASS); sleep .3
    [[ -n "$wid" ]] && echo "$wid" > $FLOATWIN_STATE/$APP && break
    time_out=$((time_out + 1))
  done
  bspc rule -r $CLASS
}

_toggle_or_create() {
  if $(__wid_expired); then __create_window
  elif $(__win_visible); then __hide_window
  else __show_window
  fi
}

main() {
  [[ -d "$FLOATWIN_STATE" ]] || mkdir -p $FLOATWIN_STATE
  while getopts "a:b:c:d:t" opt; do
    case $opt in
      a) AFTER=$OPTARG;;
      b) BEFORE=$OPTARG;;
      c) CLASS=$OPTARG;;
      d) DIMENSION=$OPTARG;;
      t) TERMINAL=true;;
    esac
  done
  shift $((OPTIND -1))
  CMD="$@"
  APP=${1:-dropterm}
  CLASS=${CLASS:-$APP}
  WID=$(cat "$FLOATWIN_STATE/$APP" 2>/dev/null)
  [ -n "$BEFORE" ] && ! pgrep "$BEFORE" >/dev/null && eval "$BEFORE &"
  _toggle_or_create
  [ -n "$AFTER" ] && ! pgrep "$AFTER" >/dev/null && eval "$AFTER &"
}

main "$@"
