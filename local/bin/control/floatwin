#!/bin/sh
FLOATWIN_STATE="$XDG_CACHE_HOME/floatwin"
TERMINAL=false
DIMENSION=1920x1080+0+0
TIMEOUT=100

__win_shown() { xdotool search --onlyvisible --desktop $(xdotool get_desktop) --class $1; }
__win_info() { bspc query -T -n $WID | jq .$@; }

_toggle_or_create() {
  if ! $(__win_info hidden) && [[ -n $(__win_shown $CLASS) ]]; then
    bspc node $WID --flag hidden=on
  elif [[ -n $(__win_info) ]]; then
    xdotool set_desktop_for_window "$WID" "$(xdotool get_desktop)"
    bspc node $WID --flag hidden=off
    xdotool windowactivate $WID
  else
    bspc rule -a $CLASS -o state=floating rectangle=$DIMENSION sticky=on
    cmd=(alacritty --class $CLASS,$CLASS)
    [[ "$APP" == "dropterm" ]] && cmd+=("-o background_opacity=0.5") || cmd+=("-e $APP")
    $TERMINAL && eval "${cmd[@]} &" || eval "$@ &"
    local time_out=0
    while [ $time_out -lt $TIMEOUT ]; do
      wid=$(__win_shown $CLASS); sleep .3
      [ -n "$wid" ] && echo "$wid" > $FLOATWIN_STATE/$APP && break
      time_out=$((time_out + 1))
    done
    bspc wm -r
  fi
}

main() {
  [[ -d "$FLOATWIN_STATE" ]] || mkdir -p $FLOATWIN_STATE
  while getopts "c:d:t" opt; do
    case $opt in
      d) DIMENSION=$OPTARG;;
      t) TERMINAL=true;;
      c) CLASS=$OPTARG;;
    esac
  done
  shift $((OPTIND -1))
  APP=${1:-dropterm}
  CLASS=${CLASS:-$APP}
  WID=$(cat "$FLOATWIN_STATE/$APP" 2>/dev/null)
  _toggle_or_create "$@"
}

main "$@"
