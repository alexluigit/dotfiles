#!/bin/sh
width=$(printf "%0.f\n" "`echo "$(tput cols) / 2 - 2" | bc`")
ext=$(tr '[:upper:]' '[:lower:]' <<< ${1##*.})

__imagedraw() {
  readonly ID_PREVIEW="preview"
  declare -p -A cmd=([action]=add [identifier]="$ID_PREVIEW" \
  [path]="$1" [height]="$2" [width]="$3" [x]="$4" [y]="$5" [scaler]="contain" ) \
  > "$FIFO_UEBERZUG"
}

__thumbcache() {
  thumbindex=$(rg -F -A1 "$1" /home/alex/.cache/lf/thumbnail/index | tail -1)
  [[ -z $thumbindex ]] && {
    CACHE=$(mktemp -u /home/alex/.cache/lf/thumbnail/cache/XXXXXX)
    case "$6" in
      pdf) pdftoppm -png -f 1 -singlefile "$1" "$CACHE";;
      epub) epub-thumbnailer "$1" "$CACHE" 1024;;
      vid) ffmpegthumbnailer -i "$1" -o "$CACHE" -s 0;;
    esac
    [[ -f $CACHE ]] && mv "$CACHE" "$CACHE.png"
    printf "$1\n$CACHE.png\n" >> /home/alex/.cache/lf/thumbnail/index
    __imagedraw "$CACHE.png" $2 $width $4 $5
  } || __imagedraw "$thumbindex" $2 $width $4 $5
}

case "$ext" in
    zip) zipinfo "$1";;
    gz) tar -ztvf "$1";;
    bz2) tar -jtvf "$1";;
    tar) tar -tvf "$1";;
    rar) unrar l "$1";;
    7z) 7z l "$1";;
    wav|mp3|flac|m4a|wma|ape|ac3|og[agx]|spx|opus|as[fx]|flac) exiftool "$1";;
    bmp|jpg|jpeg|png|xpm) __imagedraw $1 $2 $width $4 $5; exit 1;;
    pdf) __thumbcache "$@" pdf; exit 1;;
    epub) __thumbcache "$@" epub; exit 1;;
    avi|mp4|wmv|dat|3gp|ogv|mkv|mpg|mpeg|vob|fl[icv]|m2v|mov|webm|ts|mts|m4v|r[am]|qt|divx)
      __thumbcache "$@" vid; exit 1;;
    *) bat -p --color=always "$1";;
esac
