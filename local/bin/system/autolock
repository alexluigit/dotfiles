#!/usr/bin/env sh
# usage: autolock [options]
# options:
# 	-b specify a bluetooth controller and enable hibernation wakeup for it (default: usb/devices/1-2)
# 	-d specify display divices (default: DP-0)
export DISPLAY_DEVICE="DP-0"
export BLUETOOTH_CONTROLLER="usb/devices/1-2"

while getopts b:d: opt; do
  case $opt in
    b) export BLUETOOTH_CONTROLLER="$OPTARG";;
    d) export DISPLAY_DEVICE="$OPTARG";;
    *) echo >&2 "unknown option -$OPTARG";;
  esac
done
shift "$((OPTIND - 1))"

echo enabled | sudo tee -a /sys/bus/$BLUETOOTH_CONTROLLER/power/wakeup

exec xidlehook \
  --not-when-fullscreen \
  --not-when-audio \
  --timer 180 \
    'xrandr --output "$DISPLAY_DEVICE" --brightness .1' \
    'xrandr --output "$DISPLAY_DEVICE" --brightness 1' \
  --timer 60 \
    'xrandr --output "$DISPLAY_DEVICE" --brightness 1; betterlockscreen -l' \
    '' \
  --timer 900 \
    'killall i3lock && betterlockscreen -s' \
    ''
